#!/usr/bin/env bash

BASEDIR=$(realpath $(dirname "$0")/..)

#FILE_DEST="dist/$FILENAME"
FILE_DEST="dist/backend.js"
# TypeScript compiling
$BASEDIR/node_modules/.bin/tsc --project tsconfig.backend.json
EXEC=$(grep "executable" dist/plugin.json | sed -E 's/"executable":[ \t]+"(.*)",/\1/' | tr -d ' ')
OS=$(uname -s |  tr '[:upper:]' '[:lower:]')
ARCH="amd64"
FILENAME="dist/$EXEC_$OS_$ARCH"
# put out a script that runs the backend
cat <<'EOF' > $FILE_DEST
#!/usr/bin/env node
"use strict";
const app = require("./backend/index");
app.run();
EOF
chmod 755 "$FILE_DEST"

$BASEDIR/node_modules/.bin/pkg $FILE_DEST -o $FILENAME
